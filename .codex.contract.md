# Codex Contract — Web App Template (v3)

## 0) Purpose

This repository is a stable baseline for Codex-assisted development.
Codex must operate within these constraints to keep the project reproducible, beginner-safe, and consistent.

---

## 1) Environment (assumed)

- OS: macOS (Apple Silicon)
- Node: v22 (LTS)
- Package manager: npm
- Framework: Next.js (App Router) + TypeScript
- Styling: Tailwind CSS (v4) via PostCSS plugin `@tailwindcss/postcss`
- Validation: Zod
- Testing: Vitest + Testing Library
- Docker Desktop: available (optional)

---

## 2) Non-negotiable rules (safety + reproducibility)

1. **No global installs**

- Do NOT use `npm -g` or modify PATH.
- All dependencies must be added to this repo’s `package.json` (dependencies/devDependencies).

2. **No system changes**

- Do NOT suggest edits to macOS settings, shell config, Homebrew installs, or permissions.
- If a system change is required, explicitly stop and ask.

3. **No secrets**

- Never hardcode API keys, tokens, passwords, private URLs, or secrets.
- Use `.env.local` for local secrets and maintain `.env.example`.
- Ensure `.env.local` is gitignored.

4. **Minimal dependencies**

- Standards already allowed in this template: Tailwind, Zod, Vitest.
- Any additional dependency must be mainstream and justified (1–2 lines).
- Avoid adding more than 3 new dependencies in one change without asking first.

5. **Keep it simple**

- Optimize for correctness and readability over clever abstractions.
- Avoid over-engineering (no microservices, no complex meta-frameworks, no premature state libraries).

---

## 3) How Codex must respond (output contract)

For any change, Codex must provide:

1. **Plan (short)**: 3–7 bullets.
2. **File tree**: only the relevant parts.
3. **Full file contents** for every file added or changed (no partial snippets).
4. **Commands to run (exact)**:
   - `npm install` (if dependencies changed)
   - `npm run typecheck`
   - `npm run lint`
   - `npm test`
   - `npm run format:check`
   - `npm run dev` (when applicable)
5. **Expected results**: what success looks like (URLs, output, behavior).
6. **Troubleshooting**: top 5 likely failure points + targeted fixes.

---

## 4) Code quality requirements

1. **TypeScript discipline**

- Avoid `any`. If unavoidable, isolate to one boundary and justify.
- Prefer explicit types at module boundaries (API inputs/outputs).

2. **Validation (required)**

- All API inputs must be validated with Zod.
- Prefer schema-first:
  - Schemas in `src/lib/schemas/...`
  - Reuse schemas across API + UI forms when practical.
- Return consistent JSON errors with proper status codes.

3. **Logging**

- Log server-side events: request method/path and errors.
- Do not log secrets or entire request bodies by default.

4. **Tests (required)**

- New behavior must include or update tests.
- Tests should cover:
  - happy path
  - one validation/error path
  - one edge case when practical

5. **Formatting**

- Must pass ESLint and Prettier with no warnings.

---

## 5) Architectural conventions (template defaults)

1. **Next.js App Router**

- Use `src/app` conventions.
- Prefer server components by default; use client components only when required.

2. **API routes**

- Implement in `src/app/api/.../route.ts`.
- Keep handlers small; move logic to `src/lib/...`.

3. **Separation of concerns**

- UI: `src/app/...`
- Domain logic: `src/lib/...`
- Data access: `src/lib/data/...` (repository pattern)
- Schemas: `src/lib/schemas/...`

4. **Data layer**

- Start with in-memory storage when needed, but design so it can swap to Postgres later.
- Repository interface must be stable and tested.

5. **Styling**

- Tailwind utility classes are the default.
- Avoid additional styling frameworks.

---

## 6) When Codex must stop and ask

Codex must stop and ask before:

- adding authentication/authorization providers (NextAuth, Clerk, etc.)
- adding an ORM/migrations (Prisma/Drizzle/etc.)
- adding payments, email, or new third-party integrations
- introducing a global state framework (Redux, MobX, etc.)
- introducing more than 3 new dependencies in a single change

---

## 7) Definition of Done (DoD)

A change is “done” only when:

- `npm run typecheck` passes
- `npm run lint` passes
- `npm test` passes
- `npm run format:check` passes
- feature works locally (`npm run dev`)
- README updated if usage/behavior changed
